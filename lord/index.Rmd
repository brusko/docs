---
title: "Lord's Paradox"
author: "Michael Clark"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=F, cache=FALSE, comment=NA, warning=F, echo=F)
```

Summary of Pearl 2014

# Sex differences in weight gain (original Lord formulation)

## Variables
- weight time 1
- weight time 2
- weight change
- sex

## Issues

- t-test on change vs. ancova
- Statistician 1 concludes no difference in *change*
- Statistician 2 concludes a difference in time 2 if controlling for time 1


## Results

- Both statisticians are correct
- t-test on change = total effect
- ancova = direct effect

## DAG

```{r}
library(DiagrammeR)
grViz("
digraph dag1 {

  # a 'graph' statement
  graph [fontsize = 10, layout=circo] #rankdir ignored for circo

  # several 'node' statements
  Change[shape = doublecircle, fontname = Helvetica, fontcolor='gray50', fillcolor='gray95', width=.5, penwidth=0.2];
  node [shape = box, fontname = Helvetica, fontcolor='gray50', style=filled, penwidth=0]
  Sex[color=lightsalmon]; 
  T1[color=navajowhite]; 
  T2[color=navajowhite]; 


  # edge statements
  Sex -> T1[label='a' fontcolor='gray25'  color='dodgerblue'] 
  Sex->T2 [label='b' fontcolor='gray25'  color='darkred']
  T1->T2 [label='c' fontcolor='gray25'  color='dodgerblue']
  T1->Change [label='-1' color='gray75' fontcolor='gray25'  ]
  T2->Change [label='+1' color='gray75' fontcolor='gray25'  ]
}
")

```

**Indirect effect**: is a*c

**Direct effect**: b

**Total effect**: b + a*c - a

## Data Example

```{r dataSetup, echo=T}
library(dplyr)
group  = rep(c('B', 'A'), e=5)
pre = c(20,10,60,20,10,50,10,40,20,10)
post = c(70,50,90,60,50,20,10,30,50,10)

df = data.frame(id=factor(1:10), group, pre, post)
change = post-pre

dflong = tidyr::gather(df, key=time, value=score, pre:post) %>% arrange(id)
head(df)
head(dflong)
```

It's an extremely large group difference.

```{r}
library(plotly); library(dplyr)
 
plot_ly(filter(dflong, group=='A'), x=time, y=score, group=id, mode='line', showlegend=F, line=list(color='#ff5500')) %>% 
  add_trace(data=filter(dflong, group=='B'), x=time, y=score, group=id, showlegend=F, line=list(color='dodgerblue'))
```


```{r echo=T}
mod = "
  pre ~ a*group
  post ~ b*group + c*pre
  # change ~ -1*pre + 1*post
 
  # total effect
  TE := (b + a*c) - a
"

library(lavaan)
lpmod = sem(mod, data=df)

summary(lpmod)
summary(lm(change~group, df))  # t-test on change scores = total effect
summary(lm(post~group+pre, df)) # 'ancova' uncovers direct effect etc.
```

 
### Aside
Use change score adjusting for pre. Identical result, but where coef for pre  = ancova coef for pre -1

```{r}
summary(lm(change~group+pre, df))

```


# Treatment with confounding (Wainer & Brown)
## Variables
- weight time 1
- weight time 2
- weight change
- table A vs. B

## Issues

- Heavier kids more likely to sit at table B
- Two statisticians come the conclusions as before

## Results

```{r}
grViz("
digraph dag1 {

  # a 'graph' statement
  graph [fontsize = 10, layout=circo] #rankdir ignored for circo

  # several 'node' statements
  Change[shape = doublecircle, fontname = Helvetica, fontcolor='gray50', fillcolor='gray95', width=.5, penwidth=0.2];
  node [shape = box, fontname = Helvetica, fontcolor='gray50', style=filled, penwidth=0]
  Group[color=lightsalmon]; 
  T1[color=navajowhite]; 
  T2[color=navajowhite]; 


  # edge statements
  T1 -> Group[label='a' fontcolor='gray25'  color='dodgerblue'] 
  Group->T2 [label='b' fontcolor='gray25'  color='darkred']
  T1->T2 [label='c' fontcolor='gray25'  color='dodgerblue']
  T1->Change [label='-1' color='gray85' fontcolor='gray25'  ]
  T2->Change [label='+1' color='gray85' fontcolor='gray25'  ]
}
")

```

- Weight time 1 is now a confounder
- Arrow *from* time 1 to 'treatment'
- Statistician 1 is incorrect because they do not adjust
- Statistician 2



# Birth Weight Paradox
## Variables
- birthweight
- smoking mom
- infant mortality

## Issues
- No difference score
- Before, focus on clash between two seemingly legitimate methods of analysis
- Now using ancova but results seem implausible


## Results

>- low birthweight children have higher mortality rate (100 fold higher)
- children of smoking mothers notably more likely to have low birghtweight
- low birthweight children born to smoking mothers have a lower mortality rate
- Conclusion: expectant mothers should start smoking!


## Results
### Collider bias (explain away effect)


```{r}
grViz("
digraph dag1 {

  # a 'graph' statement
  graph [fontsize = 10, layout=circo] #rankdir ignored for circo

  # several 'node' statements
  node [shape = box, fontname = Helvetica, fontcolor='gray50', style=filled, penwidth=0]
  Other[color=navajowhite]; 
  BW[color=lightsalmon]; 
  Smoking[color=navajowhite]; 
  Death[color=navajowhite]; 


  # edge statements
  edge [color='gray50']
  Smoking->BW Other->BW 
  BW->Death Smoking->Death Other->Death
}
")
```

## Explanation

### Perspective 1
- Controlling just for smoking leaves other causes, resulting in bias
- Controlling for smoking changes the probability of other causes (due to BW collider) for any stratum of BW
- Example: for BW='low, if we compare smoking vs. non-smoking we are also comparing rare other causes vs. likely other causes

### Perspective 2
- Mediation context of previous: we want to know the mortality rate of babies e.g. smokers vs. non if BW controlled for
- However here we have confounders, whereas before, the fundamental assumption was that there weren't any.
- Ajusting for BW doesn't sever all paths traversing the mediator, and actually opens up a new path, and the effect is now spurious
- For low BW, comparison of smoking vs. non-smoking compares no other causes vs. other causes

```{r}
grViz("
digraph dag1 {

  # a 'graph' statement
  graph [fontsize = 10, layout=circo] #rankdir ignored for circo

  # several 'node' statements
  node [shape = box, fontname = Helvetica, fontcolor='gray50', style=filled, penwidth=0]
  Other[color=navajowhite]; 
  Death[color=navajowhite]; 
  BW[color=lightsalmon]; 
  Smoking[color=navajowhite]; 


  # edge statements
  edge [color='gray50']
  Smoking->BW Other->BW 
  Other->Death
}
")
```
